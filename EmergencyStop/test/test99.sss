#     Project: openETCS
#      Module: EmergencyStop / test
# Description: Test of EmergencyStop/Manage_Unconditional_ES
source lib.tcl

set eut EmergencyStop::Manage_EmergencyStop

proc input {t_train {nid_engine 321}} {
  SSM::set "$::eut/t_train" $t_train
  SSM::set "$::eut/trainProps.nid_engine" $nid_engine
}

proc checkOutput {tripTrain rejectNewMA} {
  SSM::check "$::eut/tripTrain" $tripTrain
  SSM::check "$::eut/rejectNewMA" $rejectNewMA
} 

proc checkMsg147 {present {t_train 0} {nid_em 0}} {
  set h "$::eut/message147.header"
  SSM::check "$::eut/message147.present" $present
  SSM::check "$h.xNID_EM" $nid_em
}

proc nop {} {
  set_InMsg_None "$::eut/messageIn"
}


puts "running test99"

# 1) nop
nop
checkOutput false false 
checkMsg147 false
SSM::cycle

# 2) receive Msg16
set_Msg16 "$eut/messageIn" 4321
input 20
checkOutput true true
checkMsg147 true 20 4321
SSM::cycle

# 3) nop
set_InMsg_None "$::eut/messageIn"
input 30
checkOutput true true
checkMsg147 false
SSM::cycle
